# GitLab CI/CD Configuration for NTU Security Scanner

stages:
  - security

variables:
  SCAN_TYPE: "fs"
  SCAN_TARGET: "."
  SEVERITY: "HIGH,CRITICAL"
  IGNORE_UNFIXED: "false"
  EXIT_CODE: "1"
  NODE_VERSION: "18"

security_scan:
  stage: security
  image: node:${NODE_VERSION}

  before_script:
    - apt-get update && apt-get install -y curl unzip tar
    - npm install

  script:
    - node index.js

  artifacts:
    reports:
      dotenv: scan-outputs.env
    paths:
      - scan-results.json
    when: always
    expire_in: 30 days

  allow_failure: false

  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "master"

security_scan_mr:
  extends: security_scan
  variables:
    GITLAB_TOKEN: $CI_JOB_TOKEN
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

security_scan_scheduled:
  extends: security_scan
  variables:
    SCAN_TYPE: "fs"
    SCAN_TARGET: "."
    SEVERITY: "LOW,MEDIUM,HIGH,CRITICAL"
    IGNORE_UNFIXED: "false"
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
